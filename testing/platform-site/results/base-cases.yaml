---
# Source: platform-site/templates/routing.yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: service-no-redirect-destination
spec:
  host: service-no-redirect.test-ns
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
  subsets:
  - name: v1
    labels:
      version: v1
  - name: dev
    labels:
      version: dev
  - name: exact-match-override
    labels:
      version: exact-match-override
  - name: version-with-redirect
    labels:
      version: version-with-redirect
---
# Source: platform-site/templates/routing.yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: service-with-redirect-destination
spec:
  host: service-with-redirect.test-ns
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
  subsets:
  - name: v1
    labels:
      version: v1
  - name: version-no-redirect
    labels:
      version: version-no-redirect
---
# Source: platform-site/templates/routing.yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: test-release-external-routes
  namespace: test-ns
spec:
  hosts:
  - "test-host.dnv.com"
  gateways:
  - gateway/one-gateway

  http: 

  - name: service-no-redirect-v1-route
    match:        
    - uri:
        prefix: /service-prefix/
    rewrite:
      uri: / # / from default
    route:
    - destination:
        host: service-no-redirect.test-ns
        subset: v1
    timeout: 3s # 3s from default
    retries:
      attempts: 3 # attempts: 3 from default 

  - name: service-no-redirect-dev-route
    match:        
    - uri:
        prefix: /dev-override-prefix/
    rewrite:
      uri: / # / from default
    route:
    - destination:
        host: service-no-redirect.test-ns
        subset: dev
    timeout: 3s # 3s from default
    retries:
      attempts: 3 # attempts: 3 from default 

  - name: service-no-redirect-exact-match-override-route
    match:
    - uri:
        exact: /dev-override-exact        
    - uri:
        prefix: /dev-override-exact/
    rewrite:
      uri: / # / from default
    route:
    - destination:
        host: service-no-redirect.test-ns
        subset: exact-match-override
    timeout: 3s # 3s from default
    retries:
      attempts: 3 # attempts: 3 from default

  - name: service-no-redirect-version-with-redirect-route-redirect
    match:
      - uri:
          exact: /service-prefix-nr
    redirect:
      uri: /service-prefix-nr/  

  - name: service-no-redirect-version-with-redirect-route
    match:        
    - uri:
        prefix: /service-prefix-nr/
    rewrite:
      uri: / # / from default
    route:
    - destination:
        host: service-no-redirect.test-ns
        subset: version-with-redirect
    timeout: 3s # 3s from default
    retries:
      attempts: 3 # attempts: 3 from default

  - name: service-with-redirect-v1-route-redirect
    match:
      - uri:
          exact: /service-prefix
    redirect:
      uri: /service-prefix/  

  - name: service-with-redirect-v1-route
    match:        
    - uri:
        prefix: /service-prefix/
    rewrite:
      uri: / # / from default
    route:
    - destination:
        host: service-with-redirect.test-ns
        subset: v1
    timeout: 3s # 3s from default
    retries:
      attempts: 3 # attempts: 3 from default 

  - name: service-with-redirect-version-no-redirect-route
    match:        
    - uri:
        prefix: /service-prefix-nr/
    rewrite:
      uri: / # / from default
    route:
    - destination:
        host: service-with-redirect.test-ns
        subset: version-no-redirect
    timeout: 3s # 3s from default
    retries:
      attempts: 3 # attempts: 3 from default
---
# Source: platform-site/templates/routing.yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: test-release-service-no-redirect-internal-routes
spec:
  hosts:
  - service-no-redirect.test-ns
  gateways:
  - mesh
  http:
  - route:
    - destination:
        host: service-no-redirect.test-ns
        subset: v1
    retries:
      attempts: 3 # attempts: 3 from default
  - route:
    - destination:
        host: service-no-redirect.test-ns
        subset: dev
    retries:
      attempts: 3 # attempts: 3 from default
  - route:
    - destination:
        host: service-no-redirect.test-ns
        subset: exact-match-override
    retries:
      attempts: 3 # attempts: 3 from default
  - route:
    - destination:
        host: service-no-redirect.test-ns
        subset: version-with-redirect
    retries:
      attempts: 3 # attempts: 3 from default
---
# Source: platform-site/templates/routing.yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: test-release-service-with-redirect-internal-routes
spec:
  hosts:
  - service-with-redirect.test-ns
  gateways:
  - mesh
  http:
  - route:
    - destination:
        host: service-with-redirect.test-ns
        subset: v1
    retries:
      attempts: 3 # attempts: 3 from default
  - route:
    - destination:
        host: service-with-redirect.test-ns
        subset: version-no-redirect
    retries:
      attempts: 3 # attempts: 3 from default
